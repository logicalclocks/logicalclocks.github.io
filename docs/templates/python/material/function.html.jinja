{#- Template for Python functions.

This template renders a Python function or method.

Context:
  function (griffe.Function): The function to render.
  root (bool): Whether this is the root object, injected with `:::` in a Markdown page.
  heading_level (int): The HTML heading level to use.
  config (dict): The configuration options.
-#}

{% block logs scoped %}
  {#- Logging block.

  This block can be used to log debug messages, deprecation messages, warnings, etc.
  -#}
  {{ log.debug("Rendering " + function.path) }}
{% endblock logs %}

{% import "language.html.jinja" as lang with context %}
{#- Language module providing the `t` translation method. -#}

<div class="doc doc-object doc-function">
  {% with obj = function, html_id = function.path %}

    {% if root %}
      {% set show_full_path = config.show_root_full_path %}
      {% set root_members = True %}
    {% elif root_members %}
      {% set show_full_path = config.show_root_members_full_path or config.show_object_full_path %}
      {% set root_members = False %}
    {% else %}
      {% set show_full_path = config.show_object_full_path %}
    {% endif %}

    {% set function_name = function.path if show_full_path else function.name %}
    {#- Brief or full function name depending on configuration. -#}
    {% set symbol_type = "method" if function.parent.is_class else "function" %}
    {#- Symbol type: method when parent is a class, function otherwise. -#}

    {% set label = config.toc_label if config.toc_label and root else function.name %}
    {% if label | upper != label %}
      {% set label = label.replace("A", "\u200bA").replace("B", "\u200bB").replace("C", "\u200bC").replace("D", "\u200bD").replace("E", "\u200bE").replace("F", "\u200bF").replace("G", "\u200bG").replace("H", "\u200bH").replace("I", "\u200bI").replace("J", "\u200bJ").replace("K", "\u200bK").replace("L", "\u200bL").replace("M", "\u200bM").replace("N", "\u200bN").replace("O", "\u200bO").replace("P", "\u200bP").replace("Q", "\u200bQ").replace("R", "\u200bR").replace("S", "\u200bS").replace("T", "\u200bT").replace("U", "\u200bU").replace("V", "\u200bV").replace("W", "\u200bW").replace("X", "\u200bX").replace("Y", "\u200bY").replace("Z", "\u200bZ") %}
    {% endif %}
    {% set label = label.replace("_", "\u200b_") %}

    {% if not root or config.show_root_heading %}
      {% filter heading(
          heading_level,
          role="function",
          id=html_id,
          class="doc doc-heading",
          toc_label=(('<code class="doc-symbol doc-symbol-toc doc-symbol-' + symbol_type + '"></code>&nbsp;')|safe if config.show_symbol_type_toc else '') + label,
          skip_inventory=config.skip_local_inventory,
        ) %}

        {% block heading scoped %}
          {#- Heading block.

          This block renders the heading for the function.
          -#}
          {% block alias_anchors scoped %}
            {% if function.extra.hopsworks_apigen and function.extra.hopsworks_apigen.aliases %}
              {% for alias in function.extra.hopsworks_apigen.aliases -%}
                {%- set alias_id = alias.target_module + "." + alias.alias_name -%}
                {% filter heading(
                  9,
                  role="function",
                  id=alias_id,
                  class="doc doc-heading",
                  hidden=true,
                  skip_inventory=config.skip_local_inventory,
                ) -%}{%- endfilter %}
              {%- endfor %}
            {% endif %}
            {% if function.parent and function.parent.extra.hopsworks_apigen and function.parent.extra.hopsworks_apigen.aliases %}
              {% for alias in function.parent.extra.hopsworks_apigen.aliases -%}
                {%- set alias_id = alias.target_module + "." + alias.alias_name + "." + function.name -%}
                {% filter heading(
                  9,
                  role="function",
                  id=alias_id,
                  class="doc doc-heading",
                  hidden=true,
                  skip_inventory=config.skip_local_inventory,
                ) -%}{%- endfilter %}
              {%- endfor %}
            {% endif %}
          {% endblock alias_anchors %}

          {% block source_link scoped %}
            {% if config.extra.link_source and function.source_link %}
              <span style="float:right;font-size:.8rem;font-weight:400"><a href="{{ function.source_link }}" class="source-link"></a></span>
            {% endif %}
          {% endblock source_link %}

          {% if config.show_symbol_type_heading %}<code class="doc-symbol doc-symbol-heading doc-symbol-{{ symbol_type }}"></code>{% endif %}
          {% if config.heading and root %}
            {{ config.heading }}
          {% elif config.separate_signature %}
            <span class="doc doc-object-name doc-function-name">{{ function_name }}</span>
          {% else %}
            {%+ filter highlight(language="python", inline=True) -%}
              {{ function_name }}
              {%- include "type_parameters.html.jinja" with context -%}
              {%- include "signature.html.jinja" with context -%}
            {%- endfilter %}
          {% endif %}
        {% endblock heading %}

        {% block labels scoped %}
          {#- Labels block.

          This block renders the labels for the function.
          -#}
          {% with labels = function.labels %}
            {% include "labels.html.jinja" with context %}
          {% endwith %}
        {% endblock labels %}

      {% endfilter %}

      {% block signature scoped %}
        {#- Signature block.

        This block renders the signature for the function,
        as well as its overloaded signatures if any.
        -#}
        {% if function.overloads and config.show_overloads %}
          <div class="doc-overloads">
            {% for overload in function.overloads %}
              {% filter format_signature(overload, config.line_length, annotations=True, crossrefs=config.signature_crossrefs) %}
                {{ overload.name }}
              {% endfilter %}
            {% endfor %}
          </div>
        {% endif %}
        {% if config.separate_signature and not (config.show_overloads and function.overloads and config.overloads_only) %}
          {% filter format_signature(function, config.line_length, crossrefs=config.signature_crossrefs) %}
            {{ function.name }}
          {% endfilter %}
        {% endif %}
      {% endblock signature %}

    {% else %}

      {% if config.show_root_toc_entry %}
        {% filter heading(
            heading_level,
            role="function",
            id=html_id,
            toc_label=(('<code class="doc-symbol doc-symbol-toc doc-symbol-' + symbol_type + '"></code>&nbsp;')|safe if config.show_symbol_type_toc else '') + label,
            hidden=True,
            skip_inventory=config.skip_local_inventory,
          ) %}
        {% endfilter %}
      {% endif %}
      {% set heading_level = heading_level - 1 %}
    {% endif %}

    <div class="doc doc-contents {% if root %}first{% endif %}">
      {% block contents scoped %}
        {#- Contents block.

        This block renders the contents of the function.
        It contains other blocks that users can override.
        Overriding the contents block allows to rearrange the order of the blocks.
        -#}
        {% block deprecation scoped %}
          {% if function.extra.hopsworks_apigen and function.extra.hopsworks_apigen.deprecated %}
            <details class="warning" open>
              <summary>Deprecated</summary>
              <p>
                {%- set dep = function.extra.hopsworks_apigen.deprecated -%}
                {%- set available_until = dep.available_until -%}
                {%- set deprecated_by = dep.deprecated_by -%}
                {%- set version = "version " + available_until if available_until else "a future release" -%}

                <code>{{ function.name }}</code> is deprecated and will be removed in {{ version }} of Hopsworks.
                Instead of it, consider using {% for rec in deprecated_by %}<autoref identifier="{{ rec }}"><code>{{ rec.split(".")[-2:] | join(".") }}</code></autoref>{% if not loop.last %}, {% endif %}{% endfor %}.
              </p>
            </details>
          {% endif %}
        {% endblock deprecation %}

        {% block docstring scoped %}
          {#- Docstring block.

          This block renders the docstring for the function.
          -#}
          {% with docstring_sections = function.docstring.parsed %}
            {% include "docstring.html.jinja" with context %}
          {% endwith %}
        {% endblock docstring %}

        {% block aliases scoped %}
          {% if function.extra.hopsworks_apigen and function.extra.hopsworks_apigen.aliases %}
            {%- set public_aliases = function.extra.hopsworks_apigen.aliases | selectattr("is_public") | list -%}
            {% if public_aliases and public_aliases[1:] %}
              <p class="doc doc-class-aliases">
                For backwards compatibility
                {% set fullpath = public_aliases[0].target_module + "." + public_aliases[0].alias_name %}
                <a href="#{{fullpath}}"><code>{{fullpath}}</code></a>
                is still available as
                {% for alias in public_aliases[1:] -%}
                  {%- set fullpath = alias.target_module + "." + alias.alias_name -%}
                  <a href="#{{fullpath}}"><code>{{fullpath}}</code></a>
                  {%- if not loop.last %}, {% endif %}
                {%- endfor %}.
                {% if public_aliases[2:] %}
                  The use of these aliases is discouraged as they are to be deprecated.
                {% else %}
                  The use of this alias is discouraged as it is to be deprecated.
                {% endif %}
              </p>
            {% endif %}
          {% endif %}
        {% endblock aliases %}

        {% block source scoped %}
          {#- Source block.

          This block renders the source code for the function.
          -#}
          {% if config.show_source and function.source %}
            <details class="mkdocstrings-source">
              <summary>{{ lang.t("Source code in") }} <code>
                {%- if function.relative_filepath.is_absolute() -%}
                  {{ function.relative_package_filepath }}
                {%- else -%}
                  {{ function.relative_filepath }}
                {%- endif -%}
              </code></summary>
              {{ function.source|highlight(language="python", linestart=function.lineno or 0, linenums=True) }}
            </details>
          {% endif %}
        {% endblock source %}
      {% endblock contents %}
    </div>

  {% endwith %}
</div>
